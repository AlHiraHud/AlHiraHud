<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Next Prayer Widget</title>

  <style>
    body {
      background: #0f1b2d;
      color: #f2f2f2;
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
    }

    #next-prayer {
      background: #152235;
      padding: 20px;
      border-radius: 12px;
      font-size: 18px;
      line-height: 1.6;
      color: #f2f2f2;
      border: 1px solid #1f2f45;
      max-width: 350px;
      margin: auto;
    }

    .gold {
      color: #d4af37;
    }
  </style>
</head>

<body>

  <h2 class="gold">üåô Ramadan Kareem</h2>
  <div id="next-prayer">Loading...</div>

  <script>
    const SCRIPT_URL = "https://alhirahud.github.io/AlHiraHud/script.js";

    async function loadPrayerSchedule() {
      try {
        const response = await fetch(SCRIPT_URL);
        const js = await response.text();

        const match = js.match(/const prayerSchedule\s*=\s*(\[[\s\S]*?\]);/);
        if (!match) return null;

        return eval(match[1]);
      } catch (err) {
        return null;
      }
    }

    function getNextPrayer(schedule) {
      const now = new Date();
      const order = ["Fajr", "Sunrise", "Dhuhr", "Asr", "Maghrib", "Isha"];

      const upcoming = schedule
        .map(entry => {
          const base = new Date(entry.date);
          return order.map(name => {
            const t = entry.times[name];
            if (!t) return null;
            const [hh, mm] = t.split(":").map(Number);
            const timeObj = new Date(base.getFullYear(), base.getMonth(), base.getDate(), hh, mm);
            return { name, timeStr: t, timeObj, date: entry.date };
          }).filter(Boolean);
        })
        .flat()
        .filter(p => p.timeObj > now);

      return upcoming.length ? upcoming[0] : null;
    }

    async function updateWidget() {
      const schedule = await loadPrayerSchedule();
      const box = document.getElementById("next-prayer");

      if (!schedule) {
        box.innerHTML = "‚ö†Ô∏è Could not load prayer times.";
        return;
      }

      const next = getNextPrayer(schedule);
      if (!next) {
        box.innerHTML = "No upcoming prayers found.";
        return;
      }

      const now = new Date();
      const diff = next.timeObj - now;
      const totalSec = Math.floor(diff / 1000);
      const hours = Math.floor(totalSec / 3600);
      const minutes = Math.floor((totalSec % 3600) / 60);
      const seconds = totalSec % 60;

      const dateObj = new Date(next.date);
      const formattedDate = dateObj.toLocaleDateString("en-GB", {
        weekday: "long",
        month: "long",
        day: "numeric"
      });

      box.innerHTML = `
        <span class="gold"><strong>Next Prayer:</strong></span> ${next.name}<br>
        <span class="gold"><strong>Time:</strong></span> ${next.timeStr}<br>
        <span style="font-size: 0.9em; color: #b8c6d1;">${formattedDate}</span><br>
        <span class="gold"><strong>Time Until:</strong></span> ${hours}h ${minutes}m ${seconds}s
      `;
    }

    updateWidget();
    setInterval(updateWidget, 1000);
  </script>

</body>
</html>